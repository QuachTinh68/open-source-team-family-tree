<!DOCTYPE html>
<html lang="vn" xmlns:th="http://www.thymeleaf.org">
<!-- Main Head -->
<head th:replace="fragments :: client_head(${pageTitle}, 'none')"></head>
<body>
	<div id="wrapper">
		<!-- page preloader begin -->
		<div id="de-loader"></div>
		<!-- page preloader close -->
		<!-- header begin -->
		<header th:replace="common/headerLD :: headerLD"></header>
		<!-- header close -->
		<!-- content begin -->
		<div class="no-bottom no-top" id="content">
			<div id="top"></div>
			<!-- section begin -->
			<section id="subheader" class="jarallax">
				<img src="/client/images/background/subheader.jpg"
					class="jarallax-img" alt="">
				<div class="center-y relative text-center">
					<div class="container">
						<div class="row">
							<div class="col-md-12 text-center">
								<h1>Đăng kí tài khoản</h1>
							</div>
							<div class="clearfix"></div>
						</div>
					</div>
				</div>
			</section>
			<!-- section close -->
			<section aria-label="section">
				<div class="container">
					<div class="row g-custom-x">
						<div class="card card-bordered" style="display: flex; justify-content: center; align-items: center; padding: 80px 0">
							<div class="card-inner card-inner-lg" style="width: 50%">
								<div class="nk-block-head">
									<div class="nk-block-head-content">
										<h4 class="nk-block-title">Đăng kí tài khoản</h4>
										<div class="nk-block-des">
											<p>Sử dụng miễn phí hoàn toàn hệ thống gia phả của bạn</p>
										</div>
									</div>
								</div>
								<form th:action="@{/api/create_user}" method="post"
									th:object="${user}" onsubmit="return checkUnique(this);">
									<div class="form-group">
										<label class="form-label" for="name">Họ tên</label>
										<div class="form-control-wrap">
											<input type="text" class="form-control form-control-lg"
												th:field="*{name}" placeholder="Nhập tên của bạn" required>
										</div>
									</div>
									<div class="form-group">
										<label class="form-label" for="userName">Tài khoản
											đăng nhập <span class="text-muted ff-italic fs-11px">(Không
												chứa khoảng trắng, kí tự đặc biệt)</span>
										<span id="checkU" class="text-danger fs-10px"></span>
										</label>
										<div class="form-control-wrap">
											<input type="text" class="form-control form-control-lg"
												th:field="*{userName}" placeholder="Nhập tên đăng nhập"
												oninput="checkUserName(this)" required>
										</div>
									</div>
									<div class="form-group">
										<label class="form-label" for="email">Email
											<span id="checkE" class="text-danger fs-10px"></span>
										</label>
										<div class="form-control-wrap">
											<input type="email" class="form-control form-control-lg"
												th:field="*{email}" placeholder="Email của bạn"
												oninput="checkEmail(this)" required>
										</div>
									</div>
									<div class="form-group">
										<label class="form-label" for="password">Mật khẩu</label>
										<div class="form-control-wrap">
											<a href="#"
												class="form-icon form-icon-right passcode-switch lg"
												data-target="password"> <em
												class="passcode-icon icon-show icon ni ni-eye"></em> <em
												class="passcode-icon icon-hide icon ni ni-eye-off"></em>
											</a> <input type="password" class="form-control form-control-lg"
												th:field="*{password}" placeholder="Nhập mật khẩu" required>
										</div>
									</div>
									<div class="form-group mt-3">
										<button class="btn btn-lg btn-primary btn-block" type="submit">Đăng
											kí</button>
									</div>
								</form>
								<div class="form-note-s2 text-center pt-4">
									Bạn đã có tài khoản 
									<a th:href="@{/login}"><strong>Đăng nhập</strong></a> |
									<a th:href="@{/api/forgot_password}"><strong>Quên mật khẩu</strong></a>
								</div>
							</div>
						</div>
					</div>
				</div>
			</section>
		</div>
		<!-- content close -->
		<a href="#" id="back-to-top"></a>
		<!-- footer begin -->
		<footer th:replace="common/footerLD :: footerLD"></footer>
		<!-- footer close -->

	</div>
	<!-- JavaScript -->
	<script th:src="@{/client/js/plugins.js}"></script>
	<script th:src="@{/client/js/designesia.js}"></script>
	<script type="text/javascript">
		
		var isUserNameValid = false;
		var isEmailValid = false;
		
		var timeoutU;
		var timeoutE;

		function checkUserName(input) {
		    clearTimeout(timeoutU);

		    timeoutU = setTimeout(function() {
		        url = "[[@{/api/check_user}]]";
		        userName = $("#userName").val();
		        csrfValue = $("input[name='_csrf']").val();
		        params = {
		            user : userName,
		            _csrf : csrfValue
		        };

		        $.post(url, params, function(response) {
		        	var checkUElement = $("#checkU");
		            if (response == "OK") {
		            	checkUElement.text('Tên đăng nhập hợp lệ').removeClass('text-danger').addClass('text-success');
		            	isUserNameValid = true;
		            } else if (response == "Duplicated") {
		            	checkUElement.text('Tên đăng nhập đã tồn tại').removeClass('text-success').addClass('text-danger');
		            	isUserNameValid = false;
		            } else {
		            	Swal.fire('Cảnh báo', 'Đã xảy ra lỗi', 'warning');
		            	isUserNameValid = false;
					}

		        }).fail(function() {
		            Swal.fire('Cảnh báo', 'Đã xảy ra lỗi', 'warning');
		            isUserNameValid = false;
		        });
		    }, 500);
		}

		function checkEmail(input) {
		    clearTimeout(timeoutE); 

		    timeoutE = setTimeout(function() {
		        url = "[[@{/api/check_email}]]";
		        userEmail = $("#email").val();
		        csrfValue = $("input[name='_csrf']").val();
		        params = {
		            email : userEmail,
		            _csrf : csrfValue
		        };

		        $.post(url, params, function(response) {
		        	var checkEElement = $("#checkE");
		            if (response == "OK") {
		            	checkEElement.text('Email hợp lệ').removeClass('text-danger').addClass('text-success');
		            	isEmailValid = true;
		            } else if (response == "Duplicated") {
		            	checkEElement.text('Email đã tồn tại').removeClass('text-success').addClass('text-danger');
		            	isEmailValid = false;
		            } else {
		            	Swal.fire('Cảnh báo', 'Đã xảy ra lỗi', 'warning');
		            	isEmailValid = false;
					}

		        }).fail(function() {
		            Swal.fire('Cảnh báo', 'Đã xảy ra lỗi', 'warning');
		            isEmailValid = false;
		        });
		    }, 500);
		}
		
		
		function checkUnique(form) {
			checkUserName($("#userName"));
			checkEmail($("#email"));

			return isUserNameValid && isEmailValid;
		}
	</script>
</body>

</html>